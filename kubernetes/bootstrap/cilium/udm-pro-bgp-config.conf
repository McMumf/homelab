!
! UDM Pro BGP Configuration for Cilium
! Upload this to Settings -> Routing -> BGP in UniFi Network UI
!
router bgp 65100
  bgp router-id 192.168.5.1
  bgp log-neighbor-changes

  ! Require explicit policy for eBGP neighbors
  bgp ebgp-requires-policy

  ! Relax autonomous system path matching for multipath routing
  bgp bestpath as-path multipath-relax
  maximum-paths 3

  ! Create peer group for Kubernetes nodes
  neighbor K8S peer-group
  neighbor K8S remote-as 65200
  neighbor K8S description Cilium BGP Speakers

  ! Kubernetes nodes on their physical network (192.168.5.x)
  neighbor 192.168.5.100 peer-group K8S
  neighbor 192.168.5.101 peer-group K8S
  neighbor 192.168.5.102 peer-group K8S
  neighbor 192.168.5.103 peer-group K8S
  neighbor 192.168.5.104 peer-group K8S
  neighbor 192.168.5.105 peer-group K8S

  ! Apply policies
  address-family ipv4 unicast
    redistribute connected
    neighbor K8S activate
    neighbor K8S next-hop-self
    neighbor K8S soft-reconfiguration inbound
    neighbor K8S route-map RM-K8S-IN in
    neighbor K8S route-map RM-K8S-OUT out
  exit-address-family
exit

! VIPs within the service IP pool
ip prefix-list K8S-IN seq 10 permit 192.168.6.0/24 le 32

! Accept Service IPs from cluster peers
route-map RM-K8S-IN permit 10
  match ip address prefix-list K8S-IN
exit

! Router client network
ip prefix-list K8S-OUT seq 10 permit 192.168.5.0/24

! Broadcast client network for cluster peers
route-map RM-K8S-OUT permit 10
  match ip address prefix-list K8S-OUT
exit
